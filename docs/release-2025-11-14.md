# 发布说明 - 2025-11-14

## 概览
- 修复 admin/platform Web 登录时 `runtime-config.js` 与 Koal SDK 的加载问题，确保离线环境也能顺利使用证书登录。
- 为三元账号新增单 IP 白名单能力（密码登录），并通过 `.env` 变量和 `init.sh` 提供默认值及配置入口。
- 引入 Keycloak 26.3.4 脚本 Provider 自动打包机制，为基于用户属性的登录限制等扩展做准备。
- 补齐 Dockerfile 权限控制与离线构建路径，引入 `Dockerfile.offline` 以便在受限环境下复用外部构建的 jar。
- 更新 `docker-compose`（含 legacy）和 `init.sh`，统一注入 KOAL vendor 配置、Traefik 路由、Keycloak scripts 相关参数。

## 主要变更
1. **前端静态资源可读性与配置注入**
   - `source/dts-admin-webapp` 与 `source/dts-platform-webapp` 新增 `public/runtime-config.js`、Koal SDK 静态文件，并在 Dockerfile 中保证文件权限，避免 nginx 返回 `text/html`。
   - 通过 `vite.config.ts` 与 `docker-entrypoint.sh` 注入 `koalVendorBase`，且 `index.html` 中兼容 `window.RUNTIME_CONFIG`，确保浏览器 console 可直接查看配置。

2. **KOAL_VENDOR_BASE / Traefik 调整**
   - `docker-compose.legacy.yml`、`docker-compose-app.yml` 增加 `KOAL_VENDOR_BASE` 环境变量，并为 `dts-admin-webapp`、`dts-platform-webapp` 提供 vendor 目录挂载（离线兜底）。
   - Traefik 新增 `vendor/koal` 路由，提升匹配优先级，避免误返回 `index.html`。

3. **Keycloak 扩展准备**
   - `services/dts-keycloak/provider-src` 中提供脚本示例，并在 compose 里设置 `KC_FEATURES`、`KC_SCRIPT_UPLOAD_ENABLED` 等变量。
   - 引入启动命令预打包 provider jar 的逻辑，方便后续将“用户 IP 白名单”之类的脚本注册为 Provider。

4. **dts-admin 密码登录 IP 白名单**
   - `KeycloakApiResource` 新增 `enforceTriadIpAllowlist`，在 `/api/keycloak/auth/login` 入口校验 sysadmin/authadmin/auditadmin 的唯一 IP。
   - `application.yml`、`init.sh`、compose 文件加入 `DTS_SECURITY_IP_ALLOWLIST_ENABLED` 与 `DTS_SECURITY_IP_ALLOWLIST_TRIAD_USERNAMES`，默认开启、允许通过 .env 调整。

5. **构建链路增强**
   - `source/dts-admin/Dockerfile`、`source/dts-platform/Dockerfile` 等增加 `apt-keys`、chmod 步骤，并提供 `Dockerfile.offline`，供提前构建 jar 后直接 COPY。
   - 在仓库根目录新增 `.m2/settings.xml`（阿里云镜像），解决离线 maven 构建的镜像源问题。

6. **脚本与文档**
   - `init.sh`：默认写入 `KOAL_VENDOR_BASE=/vendor/koal`、`ADMIN_WHITELIST_CIDRS=0.0.0.0/0` 等变量，并同步 `.env`。
   - `docs/pki-auth.md`、`docs/kc/*.png` 等补充 PKI/Keycloak 流程记录。
   - 新增 `tools/netfix.sh`、`tools/compose/arm/mkcompose.sh` 等辅助脚本。

## 后续建议
1. 使用 `docker build -f source/dts-admin/Dockerfile.offline source` + 预编译 jar 的方式在离线环境构建 web 后端镜像。
2. 重建并部署 `dts-admin-webapp`、`dts-platform-webapp` 镜像，以应用 vendor 权限修复。
3. 在 Keycloak 中为三元用户设置 `allowed-ip` 属性，并通过 `.env` 可选地替换用户名列表。
4. 如需脚本 Provider，复用 `services/dts-keycloak/provider-src`，并确认容器内 `jar` 工具可用或在镜像构建阶段提前打包。
