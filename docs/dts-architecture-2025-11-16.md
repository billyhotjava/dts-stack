# DTS 架构方案（院所数据管理平台 I 期）

## 1. 分层架构

| 层级 | 角色 | 职责 |
| --- | --- | --- |
| 数据引擎层 | 星环大数据平台（Inceptor、ELT、计算引擎） | 负责大规模数据存储、SQL/MPP 计算、可复用的元数据/质量能力；在涉密场景中仅作为受控数据源 |
| 数据服务层 | `dts-platform` | 对接星环或其他数据库，提供业务域驱动的数据模型、API/ETL 管理、自助查询、领导驾驶舱。负责接口鉴权、限流、审计、API 发布等能力 |
| 安全与主数据层 | `dts-admin` | 统一身份/权限、PKI USBKey、三元用户 IP 白名单、接口审计、主数据同步（人员/部门/项目等）、Keycloak 集成 |
| 消费层 | Keycloak、BI、下游业务系统 | 通过 dts-platform 提供的 API/驾驶舱消费所级主数据与指标；Keycloak 侧通过 `dept_code` claim 将组织信息传递给 BI/应用 |

> **降级原则**：即使星环平台不稳定，dts-admin 与 dts-platform 仍可将 Inceptor 视作普通数据库使用，关键安全/治理逻辑全部在 dts 模块内实现，保证核心业务可运行。

## 2. 数据与安全流向

```
[院级主数据 API/Excel] --> [院原始层] --> [所级主数据服务] --> [dts-admin <-Keycloak] --> [BI/应用]
                                           ↘ [dts-platform 数据服务] ↘ [星环/Inceptor 数据资产]
```

- **人员主数据**：院方通过 API（主）或 Excel（辅）提供人员信息，统一落入院原始层并记录批次。所级主数据服务扩展 `dept_code` 等本地字段后写回 dts-admin，由 dts-admin 同步到 Keycloak 属性，再由 BI/应用在 Token 中消费。
- **业务主数据**：项目、合同、PLM、QMIS 等由所级治理，存放在星环或其他数据库，但通过 dts-platform 的模型/API 输出给消费层。
- **安全**：dts-admin 承载 PKI、IP 白名单、审计、权限；dts-platform 控制对星环的访问，提供 API 网关功能，星环本身仅暴露受控 SQL/ETL 接口。

## 3. 实施计划概览（14 个月）

| 月份 | 里程碑 | 关键交付 |
| --- | --- | --- |
| T0~T0+4 | 需求调研、方案安全评审 | 院/所主数据现状评估、数据管理制度草案、安全保密方案 |
| T0+5 | 数据治理总方案评审 | 主数据模型、指标体系、治理流程、人员同步设计 |
| T0+6 | 平台上线试运行 | dts-admin/platform 初版+星环数据源接入、人员主数据打通、PKI/IP 白名单上线 |
| T0+9 | 制度/标准交付 | 所级主数据、数据仓库分层、驾驶舱、API 服务完善；文档评审通过 |
| T0+12 | 培训/验收准备 | 用户/三员培训、运维SOP、能力转移 |
| T0+14 | 交付闭环 | 所有交付物移交、质保启动 |

重点行动项：
1. **人员主数据优先**：  
   - 接入院方 API/Excel，建立同步 & 审批流程 → 落地院原始层 → 所级主数据服务。  
   - dts-admin 在用户流程中写 `dept_code` 到 Keycloak；Keycloak 配置 `dept_code` Claim；BI 解析 Token 获取部门信息。  
   - 建立冲突/比对与告警机制，确保人员信息一致。
2. **安全与运维**：PKI/USBKey、三元 IP 白名单、操作审计、离/在线测评整改；高可用部署与降级策略。  
3. **数据服务 & 治理**：在星环之上构建 ODS/DWD/DWS/ADS 分层、ETL 整合、指标建模、领导驾驶舱、自助报表；同时在 dts 平台内实现数据标准/流程/资产目录/质量管控。

## 4. 近期重点（人员主数据对接）

1. **接口实现**  
   - API 通道：实现认证、调度、增量同步、异常告警。  
   - Excel 通道：定义模板、导入流程、格式校验、差异比对。
2. **数据落地**  
   - 建立院原始层 + 所级扩展层（含 `dept_code`、岗位、所内属性等）；所有来源统一写入并保留溯源字段。  
   - 配置自动/人工审批流程，确保人员变更符合院/所协同要求。
3. **Keycloak 集成**  
   - dts-admin 用户管理流程同步 `dept_code` 属性；提供批量补写脚本。  
   - Keycloak 客户端添加 `User Attribute` Mapper 输出 `dept_code` claim；BI 流程解析 Token 获取部门信息。  
4. **验收标准**  
   - 人员数据延迟 ≤ 1 天；冲突/失败有告警且可人工干预。  
   - Keycloak/BI 获取的 `dept_code` 与所级主数据一致。  
   - 所级主数据服务提供统一 API 供 dts-platform/其他系统查询。

> 后续在人员主数据稳定后，按同样模式逐步扩展项目、合同、PLM/QMS 等主数据域，并在 dts-platform 中开放标准化的数据服务与驾驶舱。
