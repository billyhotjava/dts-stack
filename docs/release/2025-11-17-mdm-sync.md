# 2025-11-17 MDM 回调落地（人员/组织）

## 变更概览
- 新增院方 MDM 回调落地：`/api/mdm/callback` 支持 IP 直连，落盘 JSON 并自动导入。
- 人员：`type=users` 自动映射院方字段（userCode/userName/deptCode/status/identityCard/securityLevel 等）并入人员主数据，批次来源标记 MDM。
- 组织：`type=depts|orgs` 解析 deptCode/parentCode/orgCode/shortName/status/sort/type，构建组织树（deptCode 唯一键），可同步 Keycloak 组。
- 新增组织表字段（dept_code/org_code/parent_code/short_name/status/sort_order/mdm_type）；Liquibase 变更集 `20251117-01_org_mdm_fields.xml`。
- MDM 网关日志独立滚动（100MB），落盘目录 `data/mdm/yyyyMMdd/`；dts-admin 端口映射 `8080:8081` 便于院方用 IP 回调。

## 使用与验证
1. 运行 `./init.sh …` 生成 `.env`，并重建 dts-admin 以应用端口映射和 Liquibase 变更。
2. 模拟组织回调：
   ```sh
   curl -X POST "http://<IP>:8080/api/mdm/callback?type=depts" \
     -H "Content-Type: application/json" \
     -d '[{"deptCode":"D001","deptName":"研发部","parentCode":"","orgCode":"9012","status":"1","sort":"1","type":"组织"}]'
   ```
   响应包含 batchId/path/md5/records/imported；日志见 `logs/mdm-gateway.log`。
3. 模拟人员回调（同上，type=users）；缺失必填字段仅告警不会阻塞回调。

## 后续工作
- 补充“院原始层 + 所扩展层”表结构、溯源字段和数据状态；人员/组织清洗与审批流程。
- Keycloak 属性/Mapper 补写 `dept_code` 等，完善角色/密级联动到 BI。
- 组织同步后续支持更丰富的字段映射及冲突策略；必要时增加重放/回滚工具。
