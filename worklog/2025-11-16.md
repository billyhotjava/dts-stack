2025-11-16
----------------
- 需求研读：通过 OCR 解析 `docs/req/dts.pdf`，全面梳理院所数据管理平台 I 期的技术指标、交付物、工期与安全/资质要求；确认平台需覆盖数据规划、采集、仓库、治理、安全、服务、驾驶舱等全栈能力，并满足 PKI+机密级测评、信创兼容、1000 并发等指标。
- 架构定位：明确星环大数据平台（Inceptor 等）作为底层计算/存储引擎，`dts-admin` 与 `dts-platform` 负责安全、主数据、接口与涉密需求。若星环功能不稳定，则将其当普通数据库使用，所有治理/安全逻辑由 dts 体系自持，确保关键业务独立可运转。
- 主数据策略：院方人员主数据以 API 为主渠道、Excel 为补充，两路均落入“院方原始层”并记录批次；所级主数据服务负责统一扩展（如 `dept_code`）、生成标准 API/订阅，dts-admin 在用户流程中同步 `dept_code` 到 Keycloak，BI/SSO 统一消费 Token Claim。
- 安全与运维：dts-admin 实现 PKI/USBKey、三元用户 IP 白名单、审计日志，dts-platform 控制接口限流与 API 服务；对星环仅依赖标准数据源/SQL，避免安全能力缺口。设计降级策略，确保星环故障时 dts-admin/dts-platform 仍可运行核心功能。
- 实施规划：参考招标文档 14 个月里程碑制定路线图（调研→方案→上线→制度交付→培训→闭环），并提出首期重点从“人员主数据对接”入手，建立院→所的数据同步、治理制度与 Keycloak/BI 联动基础，后续逐步扩展至项目、合同、PLM/QMS 等主数据域。

第二阶段：角色 & 密级整合（2025-11-17）
----------------
- 角色矩阵：现有“所/部门 数据管理员、数据开发员”4 角色作为治理/开发主干，新增“所领导 ROLE_INST_LEADER、部门领导 ROLE_DEPT_LEADER”以及“普通员工 ROLE_EMPLOYEE”。领导角色需覆盖同级管理员权限，并额外拥有跨域数据查看、审批能力；普通员工仅能消费 BI 报表。
- Keycloak 映射：在 `dts-admin` 维护 role_template + role_mapping 表，将本地角色（含领导/员工）映射为 Keycloak Client Role / Group（如 `dts:inst-leader`、`dts:employee`），并提供同步服务（结构 + 用户绑定 + 状态日志）。同步事件与审计日志打通。
- 密级联动：密级属性（`person_security_level`）已在 Keycloak 与 dts-admin 中同步，后续授权需遵循“角色 + 密级”双因子。资源（数据集、报表、任务）在发布时标记 `security_level`，授权/共享工作流校验“用户密级 ≥ 资源密级”后才放行，并通过 Keycloak Token Claim + BI OIDC RLS 控制访问。
- BI/数据治理衔接：领导和普通员工的 BI 可视范围需体现在 dts-platform 的数据集治理与共享授权工作流中，新增审批节点与共享策略，确保数据管理员负责治理流转，领导负责审批/查看，普通员工只读。所有授权与共享操作写入审计并遵循 100 MB 滚动日志策略。
