# 工作日志 / TODO

日期: 2025-10-23

已完成
- [done] 平台端单会话误报修复：刷新/续期不再触发并发登录提示（`PortalSessionRegistry` 更新吊销原因，补充单元测试）。

待办（按优先级）
- [todo] 统一 `PortalSessionRegistry` / `PortalSessionActivityService` 的用户名大小写处理，杜绝大小写绕过单会话。
- [todo] 优化 `hasActiveSession` 与相关日志，排除过期会话并减少误判 takeover。
- [todo] 梳理集中式会话迁移方案（PostgreSQL 会话表 + Liquibase 迁移 + DAO/Service 改造）并估算工期。
- [todo] 定义会话相关审计/调试日志扩展，便于定位并发冲突与超时原因。

日期: 2025-10-12

已完成
- [done] 在 admin 增加 PKI 登录占位接口：POST /api/keycloak/auth/pki-login（默认关闭；开启但未集成时返回 501），不影响现有用户名/密码登录。
- [done] 新增配置类 PkiAuthProperties 并在应用启动中注册，使 dts.pki.* 配置可用。
- [done] 在 application.yml 增加 dts.pki.* 配置段；在 .env 增加 DTS_PKI_* 环境变量（全部默认禁用）。
- [done] 增加 docs/pki-auth.md 并在 README 补充说明，标注“默认关闭且零侵入”。
- [done] 补充 docs/pki-auth.md 的 Traefik mTLS 路由示例（file provider tls.options + dts-admin 额外路由 labels）。
- [done] 前端构建修复：平台/管理 Web 去除 TS 报错（unused/JSX/类型不符），完成 `pnpm build`。
- [done] 平台类型对齐：`SourceType` 增加 `INCEPTOR`，支持扁平化 `hiveDatabase/hiveTable` 字段。
- [done] 新增 PKI 前端封装：`src/api/services/pkiService.ts`（admin/webapp 与 platform/webapp），包含 challenge、login 与本地 agent 试签辅助。
- [done] docker-compose 增加 `DTS_PKI_*` 环境变量导出与 `services/dts-admin/vendor` 挂载，便于联调厂商网关 JAR。
- [done] 强化“基础数据维护”策略：后端仅允许 OP_ADMIN 绑定/可见，前端统一置灰；Liquibase 回填六角色对五板块菜单的可见性（排除 foundation）。

验证记录（占位自检）
- 默认配置：访问 /api/keycloak/auth/pki-login 返回 404（未启用）。
- 设置 DTS_PKI_ENABLED=true 后：返回 501（占位，提示尚未集成）。

 待办（按优先级）
- [doing] 设计并敲定 PKI 发 Token 方案（优先 Keycloak Token Exchange/impersonation），明确 realm 与 client 配置前置条件。
- [todo] 后端 `/pki-login` 成功分支：完成证书→用户映射与 Token 获取，返回与口令登录一致的数据结构。
- [todo] 在管理/平台登录页增加“证书登录”入口（Agent 首选，Gateway 备选），失败回退口令登录。
- [todo] 审计扩展：记录证书指纹/主体散列、来源 IP/UA；补充安全自测清单。
- [todo] 与甲方确认 Excel 用户导入模板的 PKI 绑定字段（subject_dn/serial/employee_id）。
- [todo] 清理/修复本机 `source/dts-admin/target` root 归属导致的只读问题（容器内构建或本地清理后 mvn package）。
- [todo] 宿主 Docker 配置修复：`snapshotter not loaded: overlay2`（对齐 storage driver/snapshotter），恢复 init/build。

备注
- 当前改动均为可配置占位，默认关闭，不影响现有登录链路。
