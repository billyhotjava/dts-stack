# main_todo（更新于 2025-11-16）

## 基本原则
- **优先级顺序**：1) 人员主数据；2) BI 平台；3) 其他平台能力（合同/项目/PLM/QMS 等域、数据治理配套）。
- **讨论先行**：每个功能或改动在编码前先与客户确认范围，防止需求跑偏。
- **日志合规**：所有业务/安全操作继续写入审计日志；纯运维脚本输出到独立日志文件，按 100 MB 分片滚动（超出立即新建）。需要在实施阶段补上自动轮转脚本及监控。

## 近期 ToDo（按优先级）

### 1. 人员主数据（P0）
**当前进度（2025-11-16）**：完成导入能力第一阶段（API/Excel/手工接入 + 主数据落库 + 审计/日志），下一步聚焦数据校验、Keycloak 属性同步、Excel 模板固化。
1. **数据接入设计**  
   - 明确院级 API & Excel 两种来源的字段映射、认证方式、调度频率。  
   - 设计双通道校验与冲突解决策略（API 与 Excel 数据冲突时的优先顺序、人工审批流程）。
2. **落地与存储**  
   - 在 `dts-admin` / `dts-platform` 中建“院原始层 + 所扩展层”表结构，包含溯源字段、批次号、数据状态。  
   - 开发 ETL/导入任务：抓取 → 校验 → 写入原始层 → 触发清洗/扩展逻辑。  
3. **Keycloak 同步**  
   - dts-admin 增加 `dept_code` 等属性管理接口、批量补写脚本。  
   - Keycloak 客户端配置 Attribute Mapper，保证 Token 暴露 `dept_code`，BI & 其他应用可读取。  
4. **监控与日志**  
   - 为 API、Excel 导入、清洗、同步链路添加统一日志分类，纳入 100 MB 轮转策略。  
   - 配置失败告警、重新执行工具，并记录操作审计。
5. **角色 + 密级整合**  
   - 建立 role_template/role_mapping，覆盖数据管理员、开发员、所/部门领导（ROLE_INST_LEADER / ROLE_DEPT_LEADER）及普通员工（ROLE_EMPLOYEE），并与授权流程打通。  
   - 开发角色同步任务：本地角色 → Keycloak Client Role/Group，记录状态与失败日志，确保领导权限 ≥ 对应管理员，普通员工仅具备 BI 访问。  
   - 调整授权/共享工作流，校验“角色 + person_security_level ≥ 资源 security_level”，同时把领导/员工可视范围映射到 BI（Superset/Metabase）RLS。

### 2. BI 平台（P1）
1. **组件选型落地**  
   - 定版 Superset/Metabase + Airflow + dbt 组合，并写明部署与网络/安全要求。  
   - 拟定容器化/Compose 清单，定义镜像来源与加固措施。
2. **SSO & PKI 集成**  
   - 通过 dts-admin 统一登录入口接入 Keycloak OIDC/PKI，验证 BI 前端认证链路。  
   - 定义角色/行列权限映射，确保 `dept_code`、岗位等属性可在 BI 中使用。
3. **人员主题仪表盘 MVP**  
   - 选取 2~3 个所需指标（编制 vs 在岗、岗位分布等）作为压测用例。  
   - 建立调度 → 数据集 → 仪表盘全链路并记录运行日志。

### 3. 其他能力（P2）
1. **数据治理 & 资产目录**：在 dts-platform 中实现标准管理、审批流程（含数据集共享授权工作流）、血缘与质量监控，按模块拆解。  
2. **业务主数据扩展**：项目、合同、PLM/QMS、财务指标等按域分批接入，复用人员主数据的流程。  
3. **安全 & 运维**：完善 IP 白名单、PKI 审计、HA/容灾、日志轮转脚本、容量监控等。

## 日志策略实施步骤
1. 盘点现有审计日志与运维日志输出位置，补上缺失的分类与字段。  
2. 选定 logrotate 或自研脚本，设置单文件 100 MB 上限，命名规则例如 `<name>-YYYYMMDD-HHMM.log`.  
3. 将轮转脚本纳入运维手册，并在 dts-admin 内记录执行操作。  
4. 定期（每日/每周）汇总日志摘要写入 worklog，便于追踪。

> 后续所有待办会继续追加到本文件；每次更新同时在会话内说明，并在实施前复核需求。
