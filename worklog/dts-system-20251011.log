===== dts-system 2025-10-11 21:45:00 (dts-system-20251011-214500.log) =====
[主题] 日志审计重构（admin 与 platform 双端落地）

[完成项]
- 数据模型扩展（admin 与 platform 同步）：
  - 新增字段：event_uuid、event_class、event_type、source_system、operator_id、operator_name、operator_roles(jsonb)、org_code、org_name、summary、details(jsonb)、record_signature、signature_key_ver。
  - Admin Liquibase：source/dts-admin/src/main/resources/config/liquibase/master.xml:25 引入 20251011 变更；变更文件 source/dts-admin/src/main/resources/config/liquibase/changelog/20251011-01_audit_event_extend.json.xml:1。
  - Platform Liquibase：source/dts-platform/src/main/resources/config/liquibase/master.xml:26 引入 20251011 变更；变更文件 source/dts-platform/src/main/resources/config/liquibase/changelog/20251011_01_audit_event_extend.xml:1。
- 审计写入服务：
  - Admin：统一封装审计落库，生成 event_uuid、source_system=admin，汇总 summary 与 details，并填充 details.target_table / target_id / action_result / request_id / param_digest，计算 record_signature 与 chain_signature；按要求截取/规范化字段。
    • 入口类：source/dts-admin/src/main/java/com/yuzhi/dts/admin/service/audit/AdminAuditService.java:46
  - Platform：同构实现，source_system=platform，details 同步包含 target_table/target_id/param_digest，摘要签名逻辑一致。
    • 入口类：source/dts-platform/src/main/java/com/yuzhi/dts/platform/service/audit/AuditTrailService.java:41
- 操作者与组织信息：
  - operator_id=用户名（username），operator_name=中文名（若可得；否则回退用户名）。
  - operator_roles 仅保留 DEPT_DATA_*/INST_DATA_* 前缀角色并规范化。
    • 规范化辅助（admin）：source/dts-admin/src/main/java/com/yuzhi/dts/admin/security/SecurityUtils.java:231（normalizeRole 改为 public）。
  - org_code 冗余 + org_name 冗余（admin 侧通过组织库解析）：source/dts-admin/src/main/java/com/yuzhi/dts/admin/service/audit/AdminAuditService.java:352 开始的构建逻辑。
- 检索与导出接口增强（admin）：
  - 所有检索/导出接口新增 eventType 过滤；Repository/Service/REST 端到端打通。
    • Repository：source/dts-admin/src/main/java/com/yuzhi/dts/admin/repository/AuditEventRepository.java:262、294（含 searchExcludeRolesExcludeActors 增加 eventType 条件与参数）。
    • REST：source/dts-admin/src/main/java/com/yuzhi/dts/admin/web/rest/AuditLogResource.java:188（调用链带上 eventType）。
- 前端（admin-webapp）审计中心：
  - 增加“事件类型”筛选项，查询与导出均透传 eventType；默认表格展示 summary，支持展开查看 details。
    • 文件：source/dts-admin-webapp/src/admin/views/audit-center.tsx:29（FilterState）、300（筛选 UI）、507（查询参数）。
- 索引优化（初版）：
  - GIN：operator_roles、details；BTREE：source_system+occurred_at、event_class+event_type+occurred_at、operator_id+occurred_at、org_code+occurred_at；summary 添加全文索引占位。
    • Admin 变更：source/dts-admin/src/main/resources/config/liquibase/changelog/20251011-01_audit_event_extend.json.xml:1
    • Platform 变更：source/dts-platform/src/main/resources/config/liquibase/changelog/20251011_01_audit_event_extend.xml:1

[行为口径]
- 时间与时区：occur_time 存 TIMESTAMPTZ；输出采用 ISO8601，固定上海时区（+08:00）（序列化全局化待最终检查）。
- 事件分类：SecurityEvent 与 AuditEvent；事件类型覆盖登录/会话/访问拒绝/越权尝试/敏感读写删/策略与配置变更/审计检索导出等，名称遵循大写下划线。
- 签名：param_digest 与 record_signature 由 AUDIT_HMAC_KEY 计算（共用密钥，保留 key_ver 字段）。
- 来源标识：source_system 由服务固定赋值（admin 或 platform）。

[验证建议]
1) 启动 admin 与 platform，登录触发 AUTH_LOGIN_SUCCESS，查看审计：
   - event_class=SecurityEvent，event_type=AUTH_LOGIN_SUCCESS；source_system=admin；operator_* 字段齐全；summary 可读。
2) 在 admin 修改组织/用户/角色，查看审计：
   - details.target_table/target_id/action_result/param_digest 存在；record_signature 非空；org_code 与 org_name 正确。
3) 在审计中心使用“事件类型”筛选并导出，确认后端事件类型过滤生效（SQL ilike）。
4) 数据库索引：使用 EXPLAIN 验证时间范围+event_type+source_system 查询命中索引；JSONB 字段涉及过滤时命中 GIN（必要时考虑改用原生 SQL 建索引以确保 GIN/FTS 语义）。

[兼容/迁移]
- 开发期无历史数据回填需求；新表结构向后兼容（旧列保留读路径的回退逻辑）。
- 变更不会影响已存在 realm；仅新增审计字段与索引。

[遗留与后续 TODO]
- Jackson 时区全局化：确保所有审计时间输出为 +08:00（如需，配置 ObjectMapper 默认 ZoneId.of("Asia/Shanghai")）。
- 月度分区：按 occurred_at 做 Range 分区（父表+子表），预建近三个月与当前月，配合定时任务按保留期 DROP 子表。
- 全文索引：summary FTS 使用 to_tsvector + GIN（当前 Liquibase 为占位，建议改 <sql> 块显式创建）。
- Platform 侧查询接口是否需要对齐 admin 的事件类型筛选（视运营需求追加）。

[已修复构建问题]
- Admin 编译错误：
  - normalizeRole 访问权限（private → public）：source/dts-admin/src/main/java/com/yuzhi/dts/admin/security/SecurityUtils.java:231。
  - Repository 方法签名缺少 eventType 参数：source/dts-admin/src/main/java/com/yuzhi/dts/admin/repository/AuditEventRepository.java:294（方法与 SQL 同步修正）。
  - 执行：`cd source && mvn -q -DskipTests -pl dts-admin -am compile` 通过。

[运维提示]
- 保留期清理：Admin 定时任务每日 02:30 清理超过保留天数的记录（见 AdminAuditService.purgeOldEvents）。
- 密钥管理：AUDIT_HMAC_KEY 由配置提供；更换密钥需配合 key_ver 管理与验签策略（当前无需验签接口）。

