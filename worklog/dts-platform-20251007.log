===== dts-platform 2025-10-07 13:36:00 (dts-platform-20251007-133600.log) =====
[2025-10-07 13:36] 平台端登录与鉴权改造（联调用Keycloak，取消前端单边放行）

[背景]
- 研发阶段存在“前端兜底假登录”和“仅前端白名单拦截”的情况，导致联调时出现：随意用户名进入但后续API 401 或 与真实权限不一致等问题。
- 目标：平台端登录必须走后端 Keycloak 验证，后端签发平台会话（opaque token），前端仅负责携带 token，不做越权放行。

[后端改造]
- 新增 Keycloak 直连认证服务（密码模式 + userinfo 丰富）：
  - 文件：source/dts-platform/src/main/java/com/yuzhi/dts/platform/service/keycloak/KeycloakAuthService.java
- 重写登录接口逻辑（必须验证成功才签发平台会话）：
  - 文件：source/dts-platform/src/main/java/com/yuzhi/dts/platform/web/rest/KeycloakAuthResource.java
  - 动作：
    - 调用 Keycloak 进行用户名/密码认证，解析 token claims 与 roles；
    - 角色映射为平台内部权限（ROLE_USER、ROLE_OP_ADMIN、ROLE_CATALOG_ADMIN、ROLE_GOV_ADMIN、ROLE_IAM_ADMIN）；
    - 明确拒绝三员（ROLE_SYS_ADMIN/ROLE_AUTH_ADMIN/ROLE_SECURITY_AUDITOR）在平台登录（401，“系统管理角色用户不能登录业务平台”）；
    - 为通过校验的用户创建平台会话（PortalSessionRegistry），下发 opaque access/refresh token；
    - 权限：基础 portal.view；若包含 ROLE_OP_ADMIN 追加 portal.manage/catalog.manage/governance.manage/iam.manage；
    - /logout 同步调用 Keycloak RP logout，再失效平台 refreshToken。

[前端调整]
- 取消默认前端单边白名单拦截（保留可开关）：
  - 仅当设置 VITE_ENABLE_FE_GUARD=true 时，才按 allowedLoginRoles/黑名单进行 FE 侧拒绝；默认不启用，完全以后端为准。
  - 代码：
    - source/dts-platform-webapp/src/store/userStore.ts
    - source/dts-platform-webapp/src/routes/components/login-auth-guard.tsx
- 联调配置：
  - docker-compose.dev.yml: dts-platform-webapp
    - VITE_ALLOWED_LOGIN_ROLES="ROLE_USER,ROLE_OP_ADMIN"（平台仅放行运维管理员与普通用户）
    - VITE_DEV_LOGIN_FALLBACK="false"（禁用兜底假登录，必须走后端）
  - 代理观测：vite.config.ts 输出 [dev-proxy] target/prefix 日志，便于确认代理是否正确对准后端。
- 环境文件命名规范化：
  - source/dts-platform-webapp/.env.dev → .env.development；.env.prod → .env.production

[验证步骤（联调）]
1) 后端：确保 dts-platform 已启动，Keycloak Issuer/Client 配置正确。
2) 前端（容器）：./dev-stop.sh --mode local && ./dev-up.sh --mode local
3) 用 opadmin 登录平台 → 期望 200，页面进入仪表/工作台；
4) 用普通用户（非三员）登录平台 → 期望 200；
5) 用三员账号(sysadmin/authadmin/auditadmin)登录平台 → 期望 401，提示“系统管理角色用户不能登录业务平台”。

[影响范围]
- 仅平台登录链路；受保护 API 仍采用 opaque token + 内省器（原有安全链路未变）。
- 生产不受影响（前端默认不做假登录；白名单仅作为可选开关）。

[手工排错要点]
- Network 观察 /api/keycloak/auth/login：401 表示 Keycloak 验证失败或命中三员拦截；
- 若登录成功但后续仍 401：检查前端是否带 Authorization: Bearer <opaque-token>；
- 若 dev 代理错位：查看控制台 [dev-proxy] 行；必要时设置 VITE_API_PROXY_TARGET=http://localhost:18082（或容器内 http://dts-platform:8081）。

[2025-10-07 20:55] ABAC 行级过滤、上下文头与部门 API + UI 接入

[范围]
- 数据集 ABAC 元数据落地、Explore 行级过滤（MVP）、部门目录 API 与前端上下文切换。

[后端改造]
- 数据集 ABAC 字段：catalog_dataset 新增 `data_level`、`scope`、`owner_dept`、`share_scope`；通过 Liquibase 回填 `data_level`：
  - 变更：source/dts-platform/src/main/resources/config/liquibase/changelog/20251008_05_dataset_abac_fields.xml
  - 实体：source/dts-platform/src/main/java/com/yuzhi/dts/platform/domain/catalog/CatalogDataset.java
- 授权关卡：在 AccessChecker 执行 Level Gate（person_security_level vs DATA_*）与 Scope Gate（DEPT/INST），缺失字段/claims 时回退旧逻辑：
  - 文件：source/dts-platform/src/main/java/com/yuzhi/dts/platform/service/security/AccessChecker.java
- Explore 行级过滤：/api/explore/query/preview 与 /execute 支持 X-Active-Scope/X-Active-Dept；当带 datasetId 时改写 SQL：
  - DEPT：包裹为 SELECT * FROM (<SQL>) t WHERE owner_dept = :active_dept；
  - INST：包裹为 SELECT * FROM (<SQL>) t WHERE share_scope IN ('SHARE_INST','PUBLIC_INST')；
  - 文件：source/dts-platform/src/main/java/com/yuzhi/dts/platform/web/rest/ExploreResource.java
- 部门目录 API：
  - 表：iam_dept（code, name_zh, name_en, parent_code, path）— Liquibase 新建：
    - source/dts-platform/src/main/resources/config/liquibase/changelog/20251008_06_iam_dept.xml
  - 实体/仓库/接口：
    - 实体：source/dts-platform/src/main/java/com/yuzhi/dts/platform/domain/iam/IamDept.java
    - 仓库：source/dts-platform/src/main/java/com/yuzhi/dts/platform/repository/iam/IamDeptRepository.java
    - 接口：GET /api/departments?keyword= — source/dts-platform/src/main/java/com/yuzhi/dts/platform/web/rest/DeptResource.java

[前端接入]
- 全局上下文与请求头：Zustand 持久化 activeScope/activeDept，Axios 拦截器自动注入 X-Active-Scope/X-Active-Dept：
  - store：source/dts-platform-webapp/src/store/contextStore.ts
  - 拦截器：source/dts-platform-webapp/src/api/apiClient.ts
- 头部“上下文”控件：切换 DEPT/INST；DEPT 时下拉选择部门（远程搜索 /api/departments）：
  - 组件：source/dts-platform-webapp/src/layouts/components/scope-switcher.tsx
  - 注入：source/dts-platform-webapp/src/layouts/components/header-simple.tsx
  - 服务：source/dts-platform-webapp/src/api/services/deptService.ts

[验证]
1) 准备：确保 Liquibase 已执行；用户 token 含 person_security_level、dept_code。
2) Explore：
   - 设 dataset.scope=DEPT、owner_dept=D001；请求头 X-Active-Scope:DEPT / X-Active-Dept:D001 → 允许；换成 D002 → 拒绝。
   - 设 dataset.scope=INST、share_scope=SHARE_INST；请求头 X-Active-Scope:INST → 允许；DEPT → 拒绝。
   - 打印 effectiveSql，确认 WHERE 条件已包裹。
3) 前端：切换“上下文”控件，Network 面板观察请求头变化；搜索下拉返回部门列表。

[说明]
- 兼容性：缺失 ABAC 字段/claims 时不拦截且不改写 SQL，保证旧数据/流程可用。

[2025-10-07 21:15] 数据集 ABAC 表单（创建/编辑）联动（UI + API）

[范围]
- 在数据集创建对话框与详情页补充以下字段并映射到后端：
  • dataLevel（DATA_PUBLIC/INTERNAL/SECRET/TOP_SECRET）
  • scope（DEPT/INST）
  • ownerDept（当 scope=DEPT；下拉选择，来源 /api/departments）
  • shareScope（当 scope=INST；SHARE_INST/PUBLIC_INST/PRIVATE_DEPT）

[文件]
- 前端：
  - 列表/创建页：source/dts-platform-webapp/src/pages/catalog/DatasetsPage.tsx
  - 详情页：source/dts-platform-webapp/src/pages/catalog/DatasetDetailPage.tsx
- 后端：
  - 列表/详情 DTO 扩展：source/dts-platform/src/main/java/com/yuzhi/dts/platform/web/rest/CatalogResource.java（toDatasetDto / updateDataset）

[验证]
- 新建数据集：选择 DATA_*、作用域与部门/共享范围，创建后跳转详情页并可在 Explore 中按上下文访问；
- 编辑数据集：修改 DATA_* 与作用域/部门后保存，回读字段准确；
- 兼容：旧数据无 ABAC 字段时不报错，编辑表单显示默认值（DATA_INTERNAL/DEPT）。

[2025-10-07 21:35] 数据集列表 ABAC 过滤与展示增强（UI + API）

[后端]
- /api/catalog/datasets 增加可选筛选参数：dataLevel、scope、ownerDept、shareScope，并在流式过滤中生效。

[前端]
- 列表页顶部增加过滤控件：DATA_*、作用域、部门（owner_dept）。
- 表格新增列：DATA_密级、Scope、Dept/Share（按作用域显示 owner_dept 或 share_scope）。

[文件]
- 后端：source/dts-platform/src/main/java/com/yuzhi/dts/platform/web/rest/CatalogResource.java
- 前端：source/dts-platform-webapp/src/pages/catalog/DatasetsPage.tsx

[2025-10-07 21:55] 统一错误码返回与前端提示（dts-sec-****）

[后端]
- 扩展 ApiResponse 增加 `code` 字段；ApiResponses 新增 `error(code,message)` 重载；
- ExploreResource 在拒绝时返回标准错误码（SCOPE_MISMATCH/RBAC_DENY/RESOURCE_NOT_VISIBLE）。

[前端]
- API 拦截器解析 `code` 并给出友好提示：
  • dts-sec-0002：提示切换上下文（作用域/部门）
  • dts-sec-0003：提示人员密级不足
  • dts-sec-0005/0006：提示缺少或非法上下文

[文件]
- 后端：
  - source/dts-platform/src/main/java/com/yuzhi/dts/platform/web/rest/ApiResponse.java
  - source/dts-platform/src/main/java/com/yuzhi/dts/platform/web/rest/ApiResponses.java
  - source/dts-platform/src/main/java/com/yuzhi/dts/platform/web/rest/ExploreResource.java
- 前端：
  - source/dts-platform-webapp/src/api/apiClient.ts

[2025-10-07 22:05] 必选 ABAC 字段校验与列表刷新逻辑

[后端]
- 当 scope=DEPT 时强制 ownerDept 非空；当 scope=INST 时强制 shareScope 非空；非法 scope 拒绝（400）。
  - 文件：source/dts-platform/src/main/java/com/yuzhi/dts/platform/web/rest/CatalogResource.java（validateAbacFields）

[前端]
- 数据集列表在 DATA_* / Scope / Dept 过滤变化时立即重新加载（useEffect 依赖扩充）。
  - 文件：source/dts-platform-webapp/src/pages/catalog/DatasetsPage.tsx
