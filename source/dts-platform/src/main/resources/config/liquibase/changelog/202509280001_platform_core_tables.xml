<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="202509280001-01" author="platform">
        <comment>Catalog: domain/dataset/masking/classification mapping</comment>
        <createTable tableName="catalog_domain">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="varchar(128)"/>
            <column name="code" type="varchar(64)"/>
            <column name="owner" type="varchar(64)"/>
            <column name="description" type="varchar(512)"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_catalog_domain_code" tableName="catalog_domain">
            <column name="code"/>
        </createIndex>

        <createTable tableName="catalog_dataset">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="varchar(128)"/>
            <column name="domain_id" type="uuid"/>
            <column name="type" type="varchar(32)"/>
            <column name="classification" type="varchar(32)"/>
            <column name="owner" type="varchar(64)"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_catalog_dataset_domain" tableName="catalog_dataset">
            <column name="domain_id"/>
        </createIndex>
        <createIndex indexName="idx_catalog_dataset_name" tableName="catalog_dataset">
            <column name="name"/>
        </createIndex>

        <createTable tableName="catalog_masking_rule">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="dataset_id" type="uuid"/>
            <column name="column_name" type="varchar(128)"/>
            <column name="function" type="varchar(64)"/>
            <column name="args" type="varchar(512)"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_masking_dataset" tableName="catalog_masking_rule">
            <column name="dataset_id"/>
        </createIndex>

        <createTable tableName="catalog_classification_mapping">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="source" type="varchar(64)"/>
            <column name="source_level" type="varchar(32)"/>
            <column name="platform_level" type="varchar(32)"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_classification_mapping_source" tableName="catalog_classification_mapping">
            <column name="source"/>
        </createIndex>
    </changeSet>

    <changeSet id="202509280001-02" author="platform">
        <comment>Modeling: standards</comment>
        <createTable tableName="modeling_standard">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="category" type="varchar(64)"/>
            <column name="key" type="varchar(128)"/>
            <column name="value" type="varchar(1024)"/>
            <column name="description" type="varchar(512)"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_modeling_standard_category" tableName="modeling_standard">
            <column name="category"/>
        </createIndex>
    </changeSet>

    <changeSet id="202509280001-03" author="platform">
        <comment>Governance: rules and compliance checks</comment>
        <createTable tableName="gov_rule">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="varchar(128)"/>
            <column name="type" type="varchar(64)"/>
            <column name="expression" type="varchar(2048)"/>
            <column name="dataset_id" type="uuid"/>
            <column name="enabled" type="boolean"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_gov_rule_dataset" tableName="gov_rule">
            <column name="dataset_id"/>
        </createIndex>

        <createTable tableName="gov_compliance_check">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="rule_id" type="uuid"/>
            <column name="status" type="varchar(32)"/>
            <column name="detail" type="varchar(4096)"/>
            <column name="checked_at" type="timestamp"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_gov_compliance_rule" tableName="gov_compliance_check">
            <column name="rule_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="202509280001-04" author="platform">
        <comment>Explore: saved queries</comment>
        <createTable tableName="explore_saved_query">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="varchar(128)"/>
            <column name="sql_text" type="varchar(4096)"/>
            <column name="dataset_id" type="uuid"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_saved_query_dataset" tableName="explore_saved_query">
            <column name="dataset_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="202509280001-05" author="platform">
        <comment>Services: personal tokens</comment>
        <createTable tableName="svc_token">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="token" type="varchar(128)"/>
            <column name="revoked" type="boolean" defaultValueBoolean="false"/>
            <column name="expires_at" type="timestamp"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_svc_token_created_by" tableName="svc_token">
            <column name="created_by"/>
        </createIndex>
    </changeSet>

    <changeSet id="202509280001-06" author="platform">
        <comment>IAM: classification, permissions, requests</comment>
        <createTable tableName="iam_classification">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="code" type="varchar(32)"/>
            <column name="label" type="varchar(64)"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_iam_classification_code" tableName="iam_classification">
            <column name="code"/>
        </createIndex>

        <createTable tableName="iam_permission">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="resource" type="varchar(64)"/>
            <column name="action" type="varchar(32)"/>
            <column name="scope" type="varchar(32)"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>

        <createTable tableName="iam_request">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="requester" type="varchar(64)"/>
            <column name="resource" type="varchar(128)"/>
            <column name="action" type="varchar(32)"/>
            <column name="reason" type="varchar(1024)"/>
            <column name="status" type="varchar(32)"/>
            <column name="created_by" type="varchar(50)"/>
            <column name="created_date" type="timestamp"/>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createIndex indexName="idx_iam_request_status" tableName="iam_request">
            <column name="status"/>
        </createIndex>
    </changeSet>

    <changeSet id="202509280001-07" author="platform">
        <comment>Seed minimal demo data</comment>
        <insert tableName="catalog_domain">
            <column name="id" value="11111111-1111-1111-1111-111111111111"/>
            <column name="name" value="企业核心域"/>
            <column name="code" value="CORE"/>
            <column name="owner" value="admin"/>
            <column name="description" value="核心经营指标"/>
            <column name="created_by" value="system"/>
            <column name="created_date" valueDate="${now}"/>
        </insert>
        <insert tableName="catalog_domain">
            <column name="id" value="22222222-2222-2222-2222-222222222222"/>
            <column name="name" value="共享域"/>
            <column name="code" value="SHARED"/>
            <column name="owner" value="admin"/>
            <column name="description" value="共享与主数据"/>
            <column name="created_by" value="system"/>
            <column name="created_date" valueDate="${now}"/>
        </insert>
        <insert tableName="catalog_dataset">
            <column name="id" value="aaaaaaa1-0000-0000-0000-000000000001"/>
            <column name="name" value="销售收入日报"/>
            <column name="domain_id" value="11111111-1111-1111-1111-111111111111"/>
            <column name="type" value="hive"/>
            <column name="classification" value="SECRET"/>
            <column name="owner" value="alice"/>
            <column name="created_by" value="system"/>
            <column name="created_date" valueDate="${now}"/>
        </insert>
        <insert tableName="catalog_dataset">
            <column name="id" value="aaaaaaa1-0000-0000-0000-000000000002"/>
            <column name="name" value="客户主数据"/>
            <column name="domain_id" value="22222222-2222-2222-2222-222222222222"/>
            <column name="type" value="jdbc"/>
            <column name="classification" value="INTERNAL"/>
            <column name="owner" value="bob"/>
            <column name="created_by" value="system"/>
            <column name="created_date" valueDate="${now}"/>
        </insert>
    </changeSet>

</databaseChangeLog>
