<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.22.xsd">

    <changeSet id="20251021-02-refine-approval-and-auditlog-rules" author="codex">
        <comment>Ensure approval request and audit log detail endpoints map to friendly descriptions</comment>
        <sql>
            WITH up_approval AS (
                UPDATE audit_operation_mapping
                   SET module_name = '审批管理',
                       action_type = '查询',
                       description_template = '查看审批请求详情：{rid|未知}',
                       source_table_template = '审批请求',
                       param_extractors = (
                           jsonb_build_object('rid','path.id')::text
                       ),
                       event_class = 'AuditEvent',
                       order_value = 8,
                       enabled = TRUE
                 WHERE url_pattern = '/api/approval-requests/{id}'
                   AND http_method IN ('ALL','GET')
                RETURNING id
            )
            INSERT INTO audit_operation_mapping (
                url_pattern, http_method, module_name, action_type,
                description_template, source_table_template, param_extractors,
                event_class, order_value, enabled
            )
            SELECT '/api/approval-requests/{id}', 'ALL', '审批管理', '查询',
                   '查看审批请求详情：{rid|未知}', '审批请求',
                   jsonb_build_object('rid','path.id')::text,
                   'AuditEvent', 8, TRUE
             WHERE NOT EXISTS (SELECT 1 FROM up_approval)
               AND NOT EXISTS (
                       SELECT 1 FROM audit_operation_mapping
                        WHERE url_pattern = '/api/approval-requests/{id}'
                          AND http_method IN ('ALL','GET')
                   );

            WITH up_audit AS (
                UPDATE audit_operation_mapping
                   SET module_name = '审计日志',
                       action_type = '查询',
                       description_template = '查看审计日志详情：{logId|未知}',
                       source_table_template = '审计日志',
                       param_extractors = (
                           jsonb_build_object('logId','path.id')::text
                       ),
                       event_class = 'AuditEvent',
                       order_value = 12,
                       enabled = TRUE
                 WHERE url_pattern = '/api/audit-logs/{id}'
                   AND http_method IN ('GET','ALL')
                RETURNING id
            )
            INSERT INTO audit_operation_mapping (
                url_pattern, http_method, module_name, action_type,
                description_template, source_table_template, param_extractors,
                event_class, order_value, enabled
            )
            SELECT '/api/audit-logs/{id}', 'GET', '审计日志', '查询',
                   '查看审计日志详情：{logId|未知}', '审计日志',
                   jsonb_build_object('logId','path.id')::text,
                   'AuditEvent', 12, TRUE
             WHERE NOT EXISTS (SELECT 1 FROM up_audit)
               AND NOT EXISTS (
                       SELECT 1 FROM audit_operation_mapping
                        WHERE url_pattern = '/api/audit-logs/{id}'
                          AND http_method IN ('GET','ALL')
                   );
        </sql>
    </changeSet>

</databaseChangeLog>
