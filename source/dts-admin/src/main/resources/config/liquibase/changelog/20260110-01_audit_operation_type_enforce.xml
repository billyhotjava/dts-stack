<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.22.xsd">

    <changeSet id="20260110-01-audit-operation-type-normalize" author="codex">
        <validCheckSum>9:6053fea773c428dff4317625a709b115</validCheckSum>
        <preConditions onFail="CONTINUE">
            <tableExists tableName="audit_operation_mapping"/>
        </preConditions>
        <sql>
            UPDATE audit_operation_mapping
            SET operation_type = CASE operation_type
                WHEN '查询' THEN 'READ'
                WHEN '新增' THEN 'CREATE'
                WHEN '修改' THEN 'UPDATE'
                WHEN '删除' THEN 'DELETE'
                WHEN '登录' THEN 'LOGIN'
                WHEN '登出' THEN 'LOGOUT'
                WHEN '导出' THEN 'EXPORT'
                WHEN '执行' THEN 'EXECUTE'
                WHEN '发布' THEN 'PUBLISH'
                WHEN '刷新' THEN 'REFRESH'
                WHEN '申请' THEN 'REQUEST'
                WHEN '测试' THEN 'TEST'
                ELSE CASE
                    WHEN operation_type IS NULL OR trim(operation_type) = '' THEN 'UNKNOWN'
                    WHEN upper(trim(operation_type)) IN ('CREATE','UPDATE','DELETE','READ','LIST','LOGIN','LOGOUT','EXPORT','EXECUTE','GRANT','REVOKE','PUBLISH','REFRESH','REQUEST','TEST','UNKNOWN')
                        THEN upper(trim(operation_type))
                    ELSE 'UNKNOWN'
                END
            END
            WHERE operation_type IS NOT NULL;
        </sql>
        <sql endDelimiter=";">
            UPDATE audit_event
            SET operation_type = CASE operation_type
                WHEN '查询' THEN 'READ'
                WHEN '新增' THEN 'CREATE'
                WHEN '修改' THEN 'UPDATE'
                WHEN '删除' THEN 'DELETE'
                WHEN '登录' THEN 'LOGIN'
                WHEN '登出' THEN 'LOGOUT'
                WHEN '导出' THEN 'EXPORT'
                WHEN '执行' THEN 'EXECUTE'
                WHEN '发布' THEN 'PUBLISH'
                WHEN '刷新' THEN 'REFRESH'
                WHEN '申请' THEN 'REQUEST'
                WHEN '测试' THEN 'TEST'
                ELSE CASE
                    WHEN operation_type IS NULL OR trim(operation_type) = '' THEN 'UNKNOWN'
                    WHEN upper(trim(operation_type)) IN ('CREATE','UPDATE','DELETE','READ','LIST','LOGIN','LOGOUT','EXPORT','EXECUTE','GRANT','REVOKE','PUBLISH','REFRESH','REQUEST','TEST','UNKNOWN')
                        THEN upper(trim(operation_type))
                    ELSE 'UNKNOWN'
                END
            END
            WHERE operation_type IS NOT NULL;
        </sql>
    </changeSet>

    <changeSet id="20260110-01a-audit-operation-type-repair" author="codex">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="audit_operation_mapping"/>
        </preConditions>
        <sql splitStatements="false">
            DO $BODY$
            BEGIN
                IF EXISTS (
                    SELECT 1 FROM information_schema.tables
                    WHERE table_name = 'audit_operation_mapping'
                ) THEN
                    UPDATE audit_operation_mapping
                    SET operation_type = 'UNKNOWN'
                    WHERE operation_type IS NOT NULL
                      AND trim(operation_type) &lt;&gt; ''
                      AND upper(trim(operation_type)) NOT IN ('CREATE','UPDATE','DELETE','READ','LIST','LOGIN','LOGOUT','EXPORT','EXECUTE','GRANT','REVOKE','PUBLISH','REFRESH','REQUEST','TEST','UNKNOWN');
                END IF;

                IF EXISTS (
                    SELECT 1 FROM information_schema.tables
                    WHERE table_name = 'audit_event'
                ) THEN
                    UPDATE audit_event
                    SET operation_type = CASE
                            WHEN operation_type IS NULL OR trim(operation_type) = '' THEN NULL
                            WHEN upper(trim(operation_type)) IN ('CREATE','UPDATE','DELETE','READ','LIST','LOGIN','LOGOUT','EXPORT','EXECUTE','GRANT','REVOKE','PUBLISH','REFRESH','REQUEST','TEST','UNKNOWN')
                                THEN upper(trim(operation_type))
                            ELSE 'UNKNOWN'
                        END
                    WHERE operation_type IS NOT NULL;
                END IF;
            END;
            $BODY$;
        </sql>
    </changeSet>

    <changeSet id="20260110-02-audit-operation-type-constraint" author="codex">
        <sql splitStatements="false">
            DO $BODY$
            BEGIN
                IF EXISTS (
                    SELECT 1 FROM information_schema.tables
                    WHERE table_name = 'audit_operation_mapping'
                ) AND NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints
                    WHERE constraint_name = 'chk_aom_operation_type_allowed'
                      AND table_name = 'audit_operation_mapping'
                ) THEN
                    EXECUTE '
                        ALTER TABLE audit_operation_mapping
                        ADD CONSTRAINT chk_aom_operation_type_allowed
                        CHECK (operation_type IN (''CREATE'',''UPDATE'',''DELETE'',''READ'',''LIST'',''LOGIN'',''LOGOUT'',''EXPORT'',''EXECUTE'',''GRANT'',''REVOKE'',''PUBLISH'',''REFRESH'',''REQUEST'',''TEST'',''UNKNOWN''))
                    ';
                END IF;

                IF EXISTS (
                    SELECT 1 FROM information_schema.tables
                    WHERE table_name = 'audit_event'
                ) AND NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints
                    WHERE constraint_name = 'chk_audit_evt_operation_type_allowed'
                      AND table_name = 'audit_event'
                ) THEN
                    EXECUTE '
                        ALTER TABLE audit_event
                        ADD CONSTRAINT chk_audit_evt_operation_type_allowed
                        CHECK (operation_type IS NULL OR operation_type IN (''CREATE'',''UPDATE'',''DELETE'',''READ'',''LIST'',''LOGIN'',''LOGOUT'',''EXPORT'',''EXECUTE'',''GRANT'',''REVOKE'',''PUBLISH'',''REFRESH'',''REQUEST'',''TEST'',''UNKNOWN''))
                    ';
                END IF;
            END;
            $BODY$;
        </sql>
    </changeSet>

    <changeSet id="20260110-03-audit-operation-type-index" author="codex">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="audit_event"/>
        </preConditions>
        <createIndex indexName="idx_audit_evt_op_type" tableName="audit_event">
            <column name="operation_type"/>
        </createIndex>
        <createIndex indexName="idx_audit_evt_group_type" tableName="audit_event">
            <column name="operation_group"/>
            <column name="operation_type"/>
        </createIndex>
    </changeSet>

    <changeSet id="20260110-04-audit-operation-group-backfill" author="codex">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="audit_operation_mapping"/>
        </preConditions>
        <sql>
            UPDATE audit_operation_mapping
            SET operation_group = CASE
                    WHEN operation_group IS NULL OR trim(operation_group) = ''
                        THEN lower(regexp_replace(coalesce(module_name, 'general'), '[^A-Za-z0-9]+', '_', 'g'))
                    ELSE operation_group
                END,
                group_display_name = CASE
                    WHEN group_display_name IS NULL OR trim(group_display_name) = ''
                        THEN coalesce(module_name, '通用')
                    ELSE group_display_name
                END
            WHERE (operation_group IS NULL OR trim(operation_group) = '')
               OR (group_display_name IS NULL OR trim(group_display_name) = '');
        </sql>
        <sql endDelimiter=";">
            UPDATE audit_event
            SET operation_group = CASE
                    WHEN operation_group IS NULL OR trim(operation_group) = ''
                        THEN lower(regexp_replace(coalesce(module, 'general'), '[^A-Za-z0-9]+', '_', 'g'))
                    ELSE operation_group
                END
            WHERE operation_group IS NULL OR trim(operation_group) = '';
        </sql>
    </changeSet>

</databaseChangeLog>
