<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.22.xsd">

    <changeSet id="20251220-02-audit-operation-mapping-seed" author="codex">
        <comment>Seed core readable rules for users/roles/audit export</comment>

        <!-- 用户管理 -->
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/keycloak/users"/>
            <column name="http_method" value="GET"/>
            <column name="module_name" value="用户管理"/>
            <column name="operation_type" value="READ"/>
            <column name="description_template" value="查询用户列表"/>
            <column name="source_table_template" value="用户"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="10"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/keycloak/users/{id}"/>
            <column name="http_method" value="GET"/>
            <column name="module_name" value="用户管理"/>
            <column name="operation_type" value="READ"/>
            <column name="description_template" value="查询用户：{targetRef|未知}"/>
            <column name="source_table_template" value="用户"/>
            <column name="param_extractors" value="{&quot;targetRef&quot;:&quot;details.目标引用&quot;}"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="9"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/keycloak/users"/>
            <column name="http_method" value="POST"/>
            <column name="module_name" value="用户管理"/>
            <column name="operation_type" value="CREATE"/>
            <column name="description_template" value="新增用户：{targetRef|未知}"/>
            <column name="source_table_template" value="用户"/>
            <column name="param_extractors" value="{&quot;targetRef&quot;:&quot;details.目标引用&quot;}"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="8"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/keycloak/users/{id}"/>
            <column name="http_method" value="PUT"/>
            <column name="module_name" value="用户管理"/>
            <column name="operation_type" value="UPDATE"/>
            <column name="description_template" value="修改用户：{targetRef|未知}"/>
            <column name="source_table_template" value="用户"/>
            <column name="param_extractors" value="{&quot;targetRef&quot;:&quot;details.目标引用&quot;}"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="8"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/keycloak/users/{id}"/>
            <column name="http_method" value="DELETE"/>
            <column name="module_name" value="用户管理"/>
            <column name="operation_type" value="DELETE"/>
            <column name="description_template" value="删除用户：{targetRef|未知}"/>
            <column name="source_table_template" value="用户"/>
            <column name="param_extractors" value="{&quot;targetRef&quot;:&quot;details.目标引用&quot;}"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="8"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

        <!-- 角色关联（简化为“修改用户角色”描述） -->
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/keycloak/users/{id}/roles"/>
            <column name="http_method" value="POST"/>
            <column name="module_name" value="角色管理"/>
            <column name="operation_type" value="UPDATE"/>
            <column name="description_template" value="修改用户角色：{targetRef|未知}"/>
            <column name="source_table_template" value="用户角色"/>
            <column name="param_extractors" value="{&quot;targetRef&quot;:&quot;details.目标引用&quot;}"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="7"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/keycloak/users/{id}/roles"/>
            <column name="http_method" value="DELETE"/>
            <column name="module_name" value="角色管理"/>
            <column name="operation_type" value="UPDATE"/>
            <column name="description_template" value="修改用户角色：{targetRef|未知}"/>
            <column name="source_table_template" value="用户角色"/>
            <column name="param_extractors" value="{&quot;targetRef&quot;:&quot;details.目标引用&quot;}"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="7"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

        <!-- 审计导出 -->
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/audit-logs/export"/>
            <column name="http_method" value="GET"/>
            <column name="module_name" value="审计日志"/>
            <column name="operation_type" value="READ"/>
            <column name="description_template" value="导出审计日志"/>
            <column name="source_table_template" value="审计日志"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="5"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

    </changeSet>

    <changeSet id="20251220-03-audit-operation-mapping-more" author="codex">
        <comment>Seed more readable rules: approvals/orgs/menus/platform SQL/modeling + catch-all</comment>

        <!-- 审批管理 -->
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/approval-requests"/>
            <column name="http_method" value="GET"/>
            <column name="module_name" value="审批管理"/>
            <column name="operation_type" value="READ"/>
            <column name="description_template" value="查询审批请求列表"/>
            <column name="source_table_template" value="审批请求"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="12"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/approval-requests/{id}"/>
            <column name="http_method" value="GET"/>
            <column name="module_name" value="审批管理"/>
            <column name="operation_type" value="READ"/>
            <column name="description_template" value="查询审批请求：{targetRef|未知}"/>
            <column name="source_table_template" value="审批请求"/>
            <column name="param_extractors" value="{&quot;targetRef&quot;:&quot;details.目标引用&quot;}"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="11"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/keycloak/approvals/{id}/{action}"/>
            <column name="http_method" value="POST"/>
            <column name="module_name" value="审批管理"/>
            <column name="operation_type" value="UPDATE"/>
            <column name="description_template" value="处理审批：{targetRef|未知}"/>
            <column name="source_table_template" value="审批请求"/>
            <column name="param_extractors" value="{&quot;targetRef&quot;:&quot;details.目标引用&quot;}"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="10"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

        <!-- 部门管理（/api/admin） -->
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/admin/orgs"/>
            <column name="http_method" value="GET"/>
            <column name="module_name" value="部门管理"/>
            <column name="operation_type" value="READ"/>
            <column name="description_template" value="查询部门列表"/>
            <column name="source_table_template" value="部门"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="12"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/admin/orgs"/>
            <column name="http_method" value="POST"/>
            <column name="module_name" value="部门管理"/>
            <column name="operation_type" value="CREATE"/>
            <column name="description_template" value="新建部门"/>
            <column name="source_table_template" value="部门"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="11"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/admin/orgs/{id}"/>
            <column name="http_method" value="PUT"/>
            <column name="module_name" value="部门管理"/>
            <column name="operation_type" value="UPDATE"/>
            <column name="description_template" value="修改部门"/>
            <column name="source_table_template" value="部门"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="11"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/admin/orgs/{id}"/>
            <column name="http_method" value="DELETE"/>
            <column name="module_name" value="部门管理"/>
            <column name="operation_type" value="DELETE"/>
            <column name="description_template" value="删除部门"/>
            <column name="source_table_template" value="部门"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="11"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

        <!-- 门户菜单管理（/api/admin/portal/menus） -->
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/admin/portal/menus"/>
            <column name="http_method" value="GET"/>
            <column name="module_name" value="菜单管理"/>
            <column name="operation_type" value="READ"/>
            <column name="description_template" value="查询门户菜单列表"/>
            <column name="source_table_template" value="门户菜单"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="12"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/admin/portal/menus"/>
            <column name="http_method" value="POST"/>
            <column name="module_name" value="菜单管理"/>
            <column name="operation_type" value="CREATE"/>
            <column name="description_template" value="新建门户菜单"/>
            <column name="source_table_template" value="门户菜单"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="11"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/admin/portal/menus/{id}"/>
            <column name="http_method" value="PUT"/>
            <column name="module_name" value="菜单管理"/>
            <column name="operation_type" value="UPDATE"/>
            <column name="description_template" value="修改门户菜单"/>
            <column name="source_table_template" value="门户菜单"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="11"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/admin/portal/menus/{id}"/>
            <column name="http_method" value="DELETE"/>
            <column name="module_name" value="菜单管理"/>
            <column name="operation_type" value="DELETE"/>
            <column name="description_template" value="删除门户菜单"/>
            <column name="source_table_template" value="门户菜单"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="11"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

        <!-- 平台：SQL 工作台与数据标准（事件由平台转发到管理端） -->
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/explore/execute"/>
            <column name="http_method" value="POST"/>
            <column name="module_name" value="数据开发"/>
            <column name="operation_type" value="READ"/>
            <column name="description_template" value="执行SQL查询"/>
            <column name="source_table_template" value="数据库查询"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="10"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/modeling/standards"/>
            <column name="http_method" value="GET"/>
            <column name="module_name" value="数据标准"/>
            <column name="operation_type" value="READ"/>
            <column name="description_template" value="查询数据标准列表"/>
            <column name="source_table_template" value="数据标准"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="9"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/modeling/standards/{id}"/>
            <column name="http_method" value="GET"/>
            <column name="module_name" value="数据标准"/>
            <column name="operation_type" value="READ"/>
            <column name="description_template" value="查询数据标准"/>
            <column name="source_table_template" value="数据标准"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="9"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/modeling/standards"/>
            <column name="http_method" value="POST"/>
            <column name="module_name" value="数据标准"/>
            <column name="operation_type" value="CREATE"/>
            <column name="description_template" value="新增数据标准"/>
            <column name="source_table_template" value="数据标准"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="9"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/modeling/standards/{id}"/>
            <column name="http_method" value="PUT"/>
            <column name="module_name" value="数据标准"/>
            <column name="operation_type" value="UPDATE"/>
            <column name="description_template" value="修改数据标准"/>
            <column name="source_table_template" value="数据标准"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="9"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/api/modeling/standards/{id}"/>
            <column name="http_method" value="DELETE"/>
            <column name="module_name" value="数据标准"/>
            <column name="operation_type" value="DELETE"/>
            <column name="description_template" value="删除数据标准"/>
            <column name="source_table_template" value="数据标准"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="9"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

        <!-- 兜底规则：所有未覆盖接口 -->
        <insert tableName="audit_operation_mapping">
            <column name="url_pattern" value="/**"/>
            <column name="http_method" value="ALL"/>
            <column name="module_name" value="未知模块"/>
            <column name="operation_type" value="EXECUTE"/>
            <column name="description_template" value="执行了操作：{event.requestUri|未知}"/>
            <column name="source_table_template" value="未知"/>
            <column name="event_class" value="AuditEvent"/>
            <column name="order_value" valueNumeric="10000"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>

    </changeSet>

</databaseChangeLog>
