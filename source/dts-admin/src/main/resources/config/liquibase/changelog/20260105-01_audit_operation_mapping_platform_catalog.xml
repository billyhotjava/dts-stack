<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.22.xsd">

    <changeSet id="20260105-01-platform-catalog-dataset-rules" author="codex">
        <comment>Refine platform catalog dataset API mappings for audit dictionary coverage</comment>
        <sql>
            WITH updated AS (
                UPDATE audit_operation_mapping
                   SET module_name = '数据目录',
                       operation_type = CASE http_method
                           WHEN 'GET' THEN 'READ'
                           WHEN 'PUT' THEN 'UPDATE'
                           WHEN 'DELETE' THEN 'DELETE'
                           ELSE operation_type
                       END,
                       description_template = CASE http_method
                           WHEN 'GET' THEN '查看数据集：{datasetLabel|未知}（ID：{datasetId|未知}）'
                           WHEN 'PUT' THEN '修改数据集：{datasetLabel|未知}（ID：{datasetId|未知}）'
                           WHEN 'DELETE' THEN '删除数据集：{datasetLabel|未知}（ID：{datasetId|未知}）'
                           ELSE description_template
                       END,
                       source_table_template = '数据资产',
                       param_extractors = (
                           (
                               COALESCE(param_extractors, '{}')::jsonb
                               - 'id' - 'datasetId' - 'datasetLabel'
                           )
                           || jsonb_build_object('datasetId', 'path.id')
                           || jsonb_build_object('datasetLabel', 'details.目标引用')
                       )::text,
                       event_class = COALESCE(event_class, 'AuditEvent'),
                       source_system = COALESCE(source_system, 'platform'),
                       order_value = COALESCE(order_value, 29),
                       enabled = COALESCE(enabled, TRUE)
                 WHERE url_pattern = '/api/catalog/datasets/{id}'
                   AND http_method IN ('GET','PUT','DELETE')
                RETURNING http_method
            )
            INSERT INTO audit_operation_mapping (
                url_pattern, http_method, module_name, operation_type,
                description_template, source_table_template, param_extractors,
                event_class, order_value, enabled, source_system
            )
            SELECT '/api/catalog/datasets/{id}', m.http_method, '数据目录', m.operation_type,
                   m.description_template, '数据资产',
                   (
                       jsonb_build_object('datasetId', 'path.id')
                       || jsonb_build_object('datasetLabel', 'details.目标引用')
                   )::text,
                   'AuditEvent', 29, TRUE, 'platform'
              FROM (
                   VALUES
                       ('GET'::text, 'READ', '查看数据集：{datasetLabel|未知}（ID：{datasetId|未知}）'),
                       ('PUT'::text, 'UPDATE', '修改数据集：{datasetLabel|未知}（ID：{datasetId|未知}）'),
                       ('DELETE'::text, 'DELETE', '删除数据集：{datasetLabel|未知}（ID：{datasetId|未知}）')
              ) AS m(http_method, operation_type, description_template)
             WHERE NOT EXISTS (
                       SELECT 1 FROM updated u WHERE u.http_method = m.http_method
                   )
               AND NOT EXISTS (
                       SELECT 1 FROM audit_operation_mapping a
                        WHERE a.url_pattern = '/api/catalog/datasets/{id}'
                          AND a.http_method = m.http_method
                   );
        </sql>
    </changeSet>

    <changeSet id="20260105-02-platform-explore-result-rules" author="codex">
        <comment>Align explore result APIs with dictionary descriptions</comment>
        <sql>
            WITH up_save AS (
                UPDATE audit_operation_mapping
                   SET module_name = '数据探索',
                       operation_type = 'CREATE',
                       description_template = '保存查询结果集（执行ID：{executionId|未知}）',
                       source_table_template = '数据查询',
                       param_extractors = (
                           (
                               COALESCE(param_extractors, '{}')::jsonb
                               - 'executionId' - 'resultName'
                           )
                           || jsonb_build_object('executionId', 'path.executionId')
                           || jsonb_build_object('resultName', 'details.目标引用')
                       )::text,
                       event_class = COALESCE(event_class, 'AuditEvent'),
                       source_system = COALESCE(source_system, 'platform'),
                       order_value = COALESCE(order_value, 29),
                       enabled = COALESCE(enabled, TRUE)
                 WHERE url_pattern = '/api/explore/save-result/{executionId}'
                   AND http_method = 'POST'
                RETURNING id
            ),
            inserted_save AS (
                INSERT INTO audit_operation_mapping (
                    url_pattern, http_method, module_name, operation_type,
                    description_template, source_table_template, param_extractors,
                    event_class, order_value, enabled, source_system
                )
                SELECT '/api/explore/save-result/{executionId}', 'POST', '数据探索', 'CREATE',
                       '保存查询结果集（执行ID：{executionId|未知}）', '数据查询',
                       (
                           jsonb_build_object('executionId', 'path.executionId')
                           || jsonb_build_object('resultName', 'details.目标引用')
                       )::text,
                       'AuditEvent', 29, TRUE, 'platform'
                 WHERE NOT EXISTS (SELECT 1 FROM up_save)
                   AND NOT EXISTS (
                       SELECT 1 FROM audit_operation_mapping a
                        WHERE a.url_pattern = '/api/explore/save-result/{executionId}'
                          AND a.http_method = 'POST'
                   )
                RETURNING id
            )
            UPDATE audit_operation_mapping
               SET module_name = '数据探索',
                   operation_type = 'READ',
                   description_template = '预览查询结果集（ID：{resultId|未知}）',
                   source_table_template = '数据查询',
                   param_extractors = (
                       (
                           COALESCE(param_extractors, '{}')::jsonb
                           - 'id' - 'resultId' - 'resultName'
                       )
                       || jsonb_build_object('resultId', 'path.id')
                       || jsonb_build_object('resultName', 'details.目标引用')
                   )::text,
                   event_class = COALESCE(event_class, 'AuditEvent'),
                   source_system = COALESCE(source_system, 'platform'),
                   order_value = COALESCE(order_value, 29),
                   enabled = COALESCE(enabled, TRUE)
             WHERE url_pattern = '/api/explore/result-preview/{id}'
               AND http_method = 'GET';

            INSERT INTO audit_operation_mapping (
                url_pattern, http_method, module_name, operation_type,
                description_template, source_table_template, param_extractors,
                event_class, order_value, enabled, source_system
            )
            SELECT '/api/explore/result-preview/{id}', 'GET', '数据探索', 'READ',
                   '预览查询结果集（ID：{resultId|未知}）', '数据查询',
                   (
                       jsonb_build_object('resultId', 'path.id')
                       || jsonb_build_object('resultName', 'details.目标引用')
                   )::text,
                   'AuditEvent', 29, TRUE, 'platform'
             WHERE NOT EXISTS (
                     SELECT 1 FROM audit_operation_mapping a
                      WHERE a.url_pattern = '/api/explore/result-preview/{id}'
                        AND a.http_method = 'GET'
                 );
        </sql>
    </changeSet>

</databaseChangeLog>

