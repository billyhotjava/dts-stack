## Dev overlay: run services from source via bind mounts and live reload

services:

  # Java backend: dts-admin (Spring Boot)
  dts-admin:
    image: ${IMAGE_MAVEN}
    working_dir: /workspace-src/dts-admin
    depends_on:
      dts-pg:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: ${DTS_PROFILE:-dev}
      SPRING_DATASOURCE_URL: jdbc:postgresql://dts-pg:5432/${PG_DB_DTADMIN:-dts_admin}
      SPRING_DATASOURCE_USERNAME: ${PG_USER_DTADMIN:-dts_admin}
      SPRING_DATASOURCE_PASSWORD: ${PG_PWD_DTADMIN:-dts_admin}
      SPRING_LIQUIBASE_ENABLED: ${SPRING_LIQUIBASE_ENABLED:-true}
      EUREKA_CLIENT_ENABLED: ${EUREKA_CLIENT_ENABLED:-false}
      SPRING_CLOUD_CONFIG_ENABLED: ${SPRING_CLOUD_CONFIG_ENABLED:-false}
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI: ${OIDC_ISSUER_URI}
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: ${OIDC_ISSUER_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID: "${OAUTH2_ADMIN_CLIENT_ID:-dts-admin}"
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET: "${OAUTH2_ADMIN_CLIENT_SECRET:-}"
      DTS_KEYCLOAK_ADMIN_CLIENT_ID: "${OAUTH2_ADMIN_CLIENT_ID:-dts-admin}"
      DTS_KEYCLOAK_ADMIN_CLIENT_SECRET: "${OAUTH2_ADMIN_CLIENT_SECRET:-}"
      # Target client that holds data roles (client roles). Default matches our realm seeds.
      DTS_KEYCLOAK_TARGET_CLIENT_ID: "${OAUTH2_PLATFORM_CLIENT_ID:-dts-platform}"
      DTS_KEYCLOAK_USE_CLIENT_ROLES: "${DTS_KEYCLOAK_USE_CLIENT_ROLES:-false}"
      # Enable org<->Keycloak group provisioning in dev; requires KC admin privileges on the client above
      DTS_KEYCLOAK_GROUP_PROVISIONING_ENABLED: "${DTS_KEYCLOAK_GROUP_PROVISIONING_ENABLED:-true}"
      # Ensure root org creation has a default data level in dev
      DTS_ORG_UNASSIGNED_DATA_LEVEL: "${DTS_ORG_UNASSIGNED_DATA_LEVEL:-INTERNAL}"
      JHIPSTER_CORS_ALLOWED_ORIGINS: "http://localhost:3001,http://127.0.0.1:3001,http://localhost:5173,http://127.0.0.1:5173,http://localhost:18011,http://127.0.0.1:18011,http://localhost:18012,http://127.0.0.1:18012,https://${HOST_ADMIN_UI},https://${HOST_PLATFORM_UI},https://${HOST_API},https://${HOST_SSO},https://192.168.8.150,http://192.168.8.150:18011,http://192.168.8.150:18012"
      JHIPSTER_CORS_ALLOWED_METHODS: "GET,POST,PUT,PATCH,DELETE,OPTIONS"
      JHIPSTER_CORS_ALLOWED_HEADERS: "*"
      JHIPSTER_CORS_ALLOW_CREDENTIALS: "true"
      SPRINGDOC_API_DOCS_ENABLED: "true"
      SPRINGDOC_SWAGGER_UI_ENABLED: "true"
      JAVA_TOOL_OPTIONS: "${JAVA_TOOL_OPTIONS:-} ${DTS_ADMIN_JAVA_TOOL_OPTIONS_EXTRA:-}"
      # Optional PKI login integration (align with app overlay)
      DTS_PKI_ENABLED: "${DTS_PKI_ENABLED:-true}"
      DTS_PKI_MODE: "${DTS_PKI_MODE:-disabled}"
      DTS_PKI_ACCEPT_FORWARDED_CERT: "${DTS_PKI_ACCEPT_FORWARDED_CERT:-false}"
      DTS_PKI_CLIENT_CERT_HEADER: "${DTS_PKI_CLIENT_CERT_HEADER:-X-Forwarded-Tls-Client-Cert}"
      DTS_PKI_ISSUER_CN: "${DTS_PKI_ISSUER_CN:-}"
      DTS_PKI_API_BASE: "${DTS_PKI_API_BASE:-}"
      DTS_PKI_API_TOKEN: "${DTS_PKI_API_TOKEN:-}"
      DTS_PKI_API_TIMEOUT: "${DTS_PKI_API_TIMEOUT:-3000}"
      DTS_PKI_ALLOW_MOCK: "${DTS_PKI_ALLOW_MOCK:-false}"
      DTS_PKI_GATEWAY_HOST: "${DTS_PKI_GATEWAY_HOST:-}"
      DTS_PKI_GATEWAY_PORT: "${DTS_PKI_GATEWAY_PORT:-0}"
      DTS_PKI_DIGEST: "${DTS_PKI_DIGEST:-SHA1}"
      DTS_PKI_VENDOR_JAR: "${DTS_PKI_VENDOR_JAR:-}"
    command:
      - bash
      - -lc
      - |
        # Patch application-dev.yml to read datasource from env placeholders (admin)
        sh /patches/patch-app-dev-yml.sh admin || true
        # Also patch shared module (dts-common) if present
        sh /patches/patch-app-dev-yml.sh common || true
        # Pre-install shared module so local repo has dts-common
        mvn -q -f /workspace-src/dts-common/pom.xml -Pdev -DskipTests -Dmodernizer.skip=true install || true
        # Build current module and run with devtools; restarts on classpath changes
        mvn -q -Pdev -DskipTests -Dmodernizer.skip=true package || true
        mvn -q -Pdev -DskipTests -Dmodernizer.skip=true spring-boot:run \
          -Dspring-boot.run.jvmArguments="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 -Djavax.net.ssl.trustStore=/etc/dts/truststore.p12 -Djavax.net.ssl.trustStorePassword=${TRUSTSTORE_PASSWORD:-changeit} -Djavax.net.ssl.trustStoreType=PKCS12" \
          -Dspring-boot.run.arguments="--spring.datasource.url=$${SPRING_DATASOURCE_URL} --spring.datasource.username=$${SPRING_DATASOURCE_USERNAME} --spring.datasource.password=$${SPRING_DATASOURCE_PASSWORD}"
    ports:
      - "18081:8081"
      - "5005:5005"
    volumes:
      - ./source:/workspace-src:z
      - maven-cache:/root/.m2
      - ./services/certs/truststore.p12:/etc/dts/truststore.p12:ro,z
      # Mount vendor PKI client jar(s) like svs-uk_custom.jar into /opt/dts/vendor
      - ./services/dts-admin/vendor:/opt/dts/vendor:ro,z
      - ./builds/patch-app-dev-yml.sh:/patches/patch-app-dev-yml.sh:ro,z
    security_opt:
      - seccomp=unconfined
    extra_hosts:
      # For Docker < 20.10, 'host-gateway' is unsupported; fall back to default bridge gateway IP.
      - "${HOST_SSO}:${HOST_GATEWAY_IP:-172.17.0.1}"
    healthcheck:
      test: ["CMD-SHELL","curl -fsS http://127.0.0.1:8081/v3/api-docs >/dev/null || wget -qO- http://127.0.0.1:8081/v3/api-docs >/dev/null"]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 120s
    networks:
      - dts-core
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dts-core"
      - "traefik.http.routers.dts-admin.rule=Host(`${HOST_API}`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.dts-admin.entrypoints=websecure"
      - "traefik.http.routers.dts-admin.tls=true"
      - "traefik.http.services.dts-admin.loadbalancer.server.port=8081"
      - "traefik.http.middlewares.dts-strip-admin.stripprefixregex.regex=/admin"
      - "traefik.http.routers.dts-admin.middlewares=dts-strip-admin@docker,cors-allow@file,security-headers@file"
      - "traefik.http.routers.dts-admin-uiapi.rule=Host(`${HOST_ADMIN_UI}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.dts-admin-uiapi.entrypoints=websecure"
      - "traefik.http.routers.dts-admin-uiapi.tls=true"
      - "traefik.http.routers.dts-admin-uiapi.service=dts-admin"
      - "traefik.http.routers.dts-admin-uiapi.middlewares=cors-allow@file,security-headers@file"
      - "traefik.http.routers.dts-admin-platformapi.rule=Host(`${HOST_PLATFORM_UI}`) && PathPrefix(`/admin/api`)"
      - "traefik.http.routers.dts-admin-platformapi.entrypoints=websecure"
      - "traefik.http.routers.dts-admin-platformapi.tls=true"
      - "traefik.http.routers.dts-admin-platformapi.service=dts-admin"
      - "traefik.http.routers.dts-admin-platformapi.middlewares=dts-strip-admin@docker,cors-allow@file,security-headers@file"

  # Java backend: dts-platform (Spring Boot)
  dts-platform:
    image: ${IMAGE_MAVEN}
    working_dir: /workspace-src/dts-platform
    depends_on:
      dts-pg:
        condition: service_healthy
      # dts-trino:
      #   condition: service_started
    environment:
      SPRING_PROFILES_ACTIVE: ${DTS_PROFILE:-dev}
      SPRING_DATASOURCE_URL: jdbc:postgresql://dts-pg:5432/${PG_DB_DTPS:-dts_platform}
      SPRING_DATASOURCE_USERNAME: ${PG_USER_DTPS:-dts_platform}
      SPRING_DATASOURCE_PASSWORD: ${PG_PWD_DTPS:-dts_platform}
      SPRING_LIQUIBASE_ENABLED: ${SPRING_LIQUIBASE_ENABLED_PLATFORM:-true}
      EUREKA_CLIENT_ENABLED: ${EUREKA_CLIENT_ENABLED:-false}
      SPRING_CLOUD_CONFIG_ENABLED: ${SPRING_CLOUD_CONFIG_ENABLED:-false}
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI: ${OIDC_ISSUER_URI}
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: ${OIDC_ISSUER_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID: "${OAUTH2_PLATFORM_CLIENT_ID:-dts-platform}"
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET: "${OAUTH2_PLATFORM_CLIENT_SECRET:-}"
      JHIPSTER_CORS_ALLOWED_ORIGINS: "http://localhost:3001,http://127.0.0.1:3001,http://localhost:5173,http://127.0.0.1:5173,http://localhost:18011,http://127.0.0.1:18011,http://localhost:18012,http://127.0.0.1:18012,https://${HOST_ADMIN_UI},https://${HOST_PLATFORM_UI},https://${HOST_API},https://${HOST_SSO},https://192.168.8.150,http://192.168.8.150:18011,http://192.168.8.150:18012"
      JHIPSTER_CORS_ALLOWED_METHODS: "GET,POST,PUT,PATCH,DELETE,OPTIONS"
      JHIPSTER_CORS_ALLOWED_HEADERS: "*"
      JHIPSTER_CORS_ALLOW_CREDENTIALS: "true"
      SPRINGDOC_API_DOCS_ENABLED: "true"
      SPRINGDOC_SWAGGER_UI_ENABLED: "true"
      DTS_JDBC_LOAD_EXTERNAL_DRIVERS: "true"
      DTS_JDBC_DRIVER_CLASS: "org.apache.hive.jdbc.HiveDriver"
      DTS_JDBC_DRIVER_JAR: "quark-driver-8.37.3.jar"
      DTS_PLATFORM_HIVE_TEST_PRESERVE_ARTIFACTS: "true"
      # Enable lightweight HTTP access logging in dev to diagnose 401s and routing
      DTS_HTTP_ACCESS_LOG: "true"
      DTS_FEATURE_PLATFORM_KC_LOCALIZATION: "true"
      # Encrypted filesystem storage for Data Standard attachments
      DATA_STANDARD_ATTACHMENT_STORAGE_STRATEGY: "filesystem"
      DATA_STANDARD_STORAGE_DIR: "/opt/dts/upload"
      # Base64 key for AES-GCM (16 bytes here for dev; replace in prod)
      # Decodes to ASCII: 0123456789abcdef (16 bytes)
      DATA_STANDARD_ENCRYPTION_KEY: "MDEyMzQ1Njc4OWFiY2RlZg=="
      # Centralize audit logs to admin in dev as well
    command:
      - bash
      - -lc
      - |
        # Patch application-dev.yml to read datasource from env placeholders (platform)
        sh /patches/patch-app-dev-yml.sh platform || true
        # Also patch shared module (dts-common) if present
        sh /patches/patch-app-dev-yml.sh common || true
        mvn -q -f /workspace-src/dts-common/pom.xml -Pdev -DskipTests -Dmodernizer.skip=true install || true
        mvn -q -Pdev -DskipTests -Dmodernizer.skip=true package || true
        mvn -q -Pdev -DskipTests -Dmodernizer.skip=true spring-boot:run \
          -Dspring-boot.run.jvmArguments="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5006 -Djavax.net.ssl.trustStore=/etc/dts/truststore.p12 -Djavax.net.ssl.trustStorePassword=${TRUSTSTORE_PASSWORD:-changeit} -Djavax.net.ssl.trustStoreType=PKCS12" \
          -Dspring-boot.run.arguments="--spring.datasource.url=$${SPRING_DATASOURCE_URL} --spring.datasource.username=$${SPRING_DATASOURCE_USERNAME} --spring.datasource.password=$${SPRING_DATASOURCE_PASSWORD}"
    ports:
      - "18082:8081"
      - "5006:5006"
    volumes:
      - ./source:/workspace-src:z
      - maven-cache:/root/.m2
      - ./services/certs/truststore.p12:/etc/dts/truststore.p12:ro,z
      - ./services/dts-platform/drivers:/opt/dts/drivers:ro,z
      - ./services/dts-platform/upload:/opt/dts/upload:Z
      - ./builds/patch-app-dev-yml.sh:/patches/patch-app-dev-yml.sh:ro,z
    security_opt:
      - seccomp=unconfined
    extra_hosts:
      - "${HOST_SSO}:${HOST_GATEWAY_IP:-172.17.0.1}"
      - "tdh01:172.16.0.154"
    healthcheck:
      test: ["CMD-SHELL","curl -fsS http://127.0.0.1:8081/v3/api-docs >/dev/null || wget -qO- http://127.0.0.1:8081/v3/api-docs >/dev/null"]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 120s
    networks:
      - dts-core
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dts-core"
      - "traefik.http.routers.dts-platform.rule=Host(`${HOST_API}`) && PathPrefix(`/platform`)"
      - "traefik.http.routers.dts-platform.entrypoints=websecure"
      - "traefik.http.routers.dts-platform.tls=true"
      - "traefik.http.services.dts-platform.loadbalancer.server.port=8081"
      - "traefik.http.middlewares.dts-strip-platform.stripprefixregex.regex=/platform"
      - "traefik.http.routers.dts-platform.middlewares=dts-strip-platform@docker,cors-allow@file,security-headers@file"


  # Frontend: dts-admin-webapp (optional dev server)
  # If your project uses Vite/React/Angular dev server, adjust command/port below.
  dts-admin-webapp:
    image: node:22-bookworm
    working_dir: /workspace
    depends_on:
      - dts-admin
    environment:
      PNPM_STORE_DIR: /pnpm-store
      BROWSER: none
      VITE_OPEN: "false"
      VITE_ENABLE_MOCK: "false"
      CHOKIDAR_USEPOLLING: "false"
      HOST: 0.0.0.0
      PORT: "3001"
      # Vite dev proxy target for admin webapp: call dts-admin directly
      VITE_API_PROXY_TARGET: http://dts-admin:8081
      # Toggle password login UI for admin webapp during dev builds
      WEBAPP_PASSWORD_LOGIN_ENABLED: ${ADMIN_WEBAPP_PASSWORD_LOGIN_ENABLED:-}
      VITE_HIDE_PASSWORD_LOGIN: ${ADMIN_VITE_HIDE_PASSWORD_LOGIN:-}
    command: ["sh","-lc","if [ -f package.json ]; then corepack enable; pnpm install --frozen-lockfile --ignore-scripts || pnpm install --no-frozen-lockfile --ignore-scripts; sh /patches/patch-vite-env.sh || true; pnpm run dev -- --host 0.0.0.0 --port ${PORT:-3001} --strictPort --open=false || PORT=${PORT:-3001} pnpm start; else echo no\ package.json\ found; tail -f /dev/null; fi"]
    ports:
      - "18011:3001"
    volumes:
      - ./source/dts-admin-webapp:/workspace:z
      - ./source/dts-platform-webapp:/workspace/dts-platform-webapp:ro,z
      - ./builds/patch-vite-env.sh:/patches/patch-vite-env.sh:ro,z
      - pnpm-store:/pnpm-store
      - /workspace/node_modules
    networks:
      - dts-core
    healthcheck:
      test: ["CMD-SHELL","curl -fsS http://127.0.0.1:$${PORT:-3001} >/dev/null || wget -qO- http://127.0.0.1:$${PORT:-3001} >/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  # Frontend: dts-platform-webapp (optional dev server)
  dts-platform-webapp:
    image: node:22-bookworm
    working_dir: /workspace
    depends_on:
      - dts-platform
    environment:
      PNPM_STORE_DIR: /pnpm-store
      BROWSER: none
      VITE_OPEN: "false"
      VITE_ENABLE_MOCK: "false"
      CHOKIDAR_USEPOLLING: "false"
      HOST: 0.0.0.0
      PORT: "3001"
      # Vite dev proxy target for platform webapp: call dts-platform directly
      VITE_API_PROXY_TARGET: http://dts-platform:8081
      # Ensure no prefix rewrite in dev; backend already serves at /api
      VITE_API_PROXY_PREFIX: ""
      # Enforce FE guard consistently (dev == prod)
      VITE_ENABLE_FE_GUARD: "true"
      # Allow all authenticated users to sign in (empty â†’ allow all; triad still governed by backend policy)
      VITE_ALLOWED_LOGIN_ROLES: ""
      VITE_DEV_LOGIN_FALLBACK: "false"
      # Admin API base URL used by the frontend code. Use same-origin path to avoid browser CORS in dev,
      # and let Vite proxy '/admin/api' to the real admin service (see VITE_ADMIN_PROXY_TARGET below).
      VITE_ADMIN_API_BASE_URL: "/admin/api"
      # Vite dev proxy target for admin API; use direct container address in dev to avoid TLS and Traefik
      # Note: vite.config rewrites '/admin/api' -> '/api' for the target, so do NOT include '/api' suffix here.
      VITE_ADMIN_PROXY_TARGET: "http://dts-admin:8081"
      # Toggle password login UI for platform webapp during dev builds
      WEBAPP_PASSWORD_LOGIN_ENABLED: ${PLATFORM_WEBAPP_PASSWORD_LOGIN_ENABLED:-}
      VITE_HIDE_PASSWORD_LOGIN: ${PLATFORM_VITE_HIDE_PASSWORD_LOGIN:-}
    command: ["sh","-lc","if [ -f package.json ]; then corepack enable; pnpm install --frozen-lockfile --ignore-scripts || pnpm install --no-frozen-lockfile --ignore-scripts; sh /patches/patch-vite-env.sh || true; pnpm run dev -- --host 0.0.0.0 --port ${PORT:-3001} --strictPort --open=false || PORT=${PORT:-3001} pnpm start; else echo no\ package.json\ found; tail -f /dev/null; fi"]
    ports:
      - "18012:3001"
    volumes:
      - ./source/dts-platform-webapp:/workspace:z
      - ./builds/patch-vite-env.sh:/patches/patch-vite-env.sh:ro,z
      - pnpm-store:/pnpm-store
      - /workspace/node_modules
    networks:
      - dts-core
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dts-core"
      - "traefik.http.routers.platform-ui.rule=Host(`${HOST_PLATFORM_UI}`)"
      - "traefik.http.routers.platform-ui.entrypoints=websecure"
      - "traefik.http.routers.platform-ui.tls=true"
      - "traefik.http.services.platform-ui.loadbalancer.server.port=${PORT:-3001}"
      - "traefik.http.routers.platform-ui.middlewares=security-headers@file"
    healthcheck:
      test: ["CMD-SHELL","curl -fsS http://127.0.0.1:$${PORT:-3001} >/dev/null || wget -qO- http://127.0.0.1:$${PORT:-3001} >/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

volumes:
  pnpm-store:

## Note: top-level networks may also be defined in docker-compose.yml
